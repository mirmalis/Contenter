@inherits _Displayer<Contenter.Models.Contents.Content, Guid>

<ExpList
  ParamExpectedCount="1"
  ParamSource=@(
    this.Source.Select(item => new {
      item.Name,
      item.PublishedAt,
      Fam = item.FamId == null ? null : new {
        Id = item.FamId!.Value,
        item.Fam!.Name,
        Parent = item.Fam.ParentId == null ? null : new {
          Id = item.Fam.ParentId!.Value,
          item.Fam.Parent!.Name,
        }
      },
      Guests =  item.GuestPersonaAssignments
      .OrderBy(item => item.Index)
      .Select(ass => new {
        Id = ass.GuestId,
        ass.Guest.Name,
      }),
      Sources = item.SourceAssignments
      .OrderBy(item => item.Index)
      .Select(ass => new {
        Id = ass.SourceId,
        ass.Source.Href,
        ass.Source.Flags,
        Definition = ass.Source.Definition == null ? null : new {
          ass.Source.Definition.Name,
          Platform = new {
            ass.Source.Definition.Platform.Id,
            ass.Source.Definition.Platform.Name,
            ass.Source.Definition.Platform.IconPath,
          }
        }
      })
    })
  )
>
  <IfSome Context="model">
    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="4">
      @if (model.Fam != null)
      {
        @if (model.Fam.Parent != null)
        {
          <a href="/c/fam/@model.Fam.Parent.Id">@model.Fam.Parent.Name</a>
          <text> &raquo; </text>
        }
        <a href="/c/fam/@model.Fam.Id">@model.Fam.Name</a>
        <text> &raquo; </text>
      }
      <Name ParamName=@model.Name />
    </FluentStack>
    @Before
    @if (model.PublishedAt != null)
    {
      <div>
        Published: @model.PublishedAt.Value.ToShortDateString()
      </div>
    }
    <div>
      Guests: 
      <OneOrMany ParamList=@(model.Guests) Context="guest">
        <a href="/p/personas/@guest.Id">@guest.Name</a>
      </OneOrMany>
    </div>
    <div>
      Sources (<a href="/create/s/sources?ContentId=@this.Id">add</a>): 
      <OneOrMany ParamList=@(model.Sources) Context="source">
        <ChildContent>
          <AuthorizeView>
            <Authorized>
              <AIcon href=@source.Href DefinitionName=@source.Definition?.Name iconPath=@source.Definition?.Platform.IconPath PlatformId=@source.Definition?.Platform.Id PlatformName=@source.Definition?.Platform.Name Flags=source.Flags>
                source
              </AIcon>
            </Authorized>
            <NotAuthorized>
              @if (model.Fam != null && source.Flags.HasFlag(Models.Sources.SourceFlags.Paid))
                {
                  <a href="/c/fam/@model.Fam.Id/pay">
                    Mokamas
                  </a>
                }
                else
                {
                  <AIcon href=@source.Href DefinitionName=@source.Definition?.Name iconPath=@source.Definition?.Platform.IconPath PlatformId=@source.Definition?.Platform.Id PlatformName=@source.Definition?.Platform.Name Flags=source.Flags>
                    source
                  </AIcon>
                }
              </NotAuthorized>
            </AuthorizeView>
        </ChildContent>
      </OneOrMany>
    </div>
    @After
  </IfSome>
</ExpList>
